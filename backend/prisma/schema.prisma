// backend/prisma/schema.prisma - EKSIKSIZ VERSIYON (User.name field'ı ile)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TriggerType {
  INACTIVITY
  EVENT
  SEGMENT_ENTRY
  SEGMENT_EXIT
  TIME_BASED
  DEPOSIT_THRESHOLD
  WITHDRAWAL_THRESHOLD
  LOGIN_STREAK
  LOSS_STREAK
  WIN_STREAK
  FIRST_DEPOSIT
  BIRTHDAY
  ACCOUNT_ANNIVERSARY
  LOW_BALANCE
  HIGH_BALANCE
  GAME_SPECIFIC
  BET_SIZE
  SESSION_DURATION
  MULTIPLE_FAILED_DEPOSITS
  RTP_THRESHOLD
  BONUS_EXPIRY
}

enum ActionType {
  SEND_TELEGRAM_MESSAGE
  SEND_EMAIL
  SEND_SMS
  SEND_PUSH_NOTIFICATION
  ADD_BONUS
  ADD_FREE_SPINS
  ADJUST_LOYALTY_POINTS
  CHANGE_VIP_TIER
  APPLY_CASHBACK
  SEND_IN_APP_MESSAGE
  TRIGGER_POPUP
  ADD_TO_SEGMENT
  REMOVE_FROM_SEGMENT
  FLAG_ACCOUNT
  CREATE_TASK
  WEBHOOK
  CUSTOM_JAVASCRIPT
}

// ============================================
// MODELS
// ============================================

model Customer {
  id                String   @id @default(cuid())
  name              String
  apiKey            String   @unique
  scriptId          String   @unique

  // Domain güvenliği için
  allowedDomains    String[]

  telegramBotToken  String?
  metaPixelId       String?
  metaAccessToken   String?
  googleAdsId       String?
  googleApiSecret   String?
  domConfig         Json?

  users             User[]
  events            Event[]
  segments          Segment[]
  rules             Rule[]
  ruleExecutions    RuleExecution[]
  fraudAlerts       FraudAlert[]
  playerRiskProfiles PlayerRiskProfile[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  @@index([scriptId])
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  name       String
  password   String
  role       String   @default("MEMBER")
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@index([customerId])
  @@index([customerId, role])
}

model Event {
  id         Int      @id @default(autoincrement())
  createdAt  DateTime @default(now())
  apiKey     String
  sessionId  String
  playerId   String?
  eventName  String
  url        String
  parameters Json?
  ipAddress  String?  // ← YENİ ALAN
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  @@index([customerId, playerId])
  @@index([eventName])
  @@index([createdAt])
  @@index([customerId, playerId, eventName])
  @@index([customerId, eventName, createdAt])
  @@index([sessionId])
  @@index([ipAddress])  // ← YENİ INDEX
  @@index([customerId, ipAddress])  // ← YENİ INDEX
  @@index([customerId, playerId, ipAddress])  // ← YENİ INDEX
}

model Player {
  id                    Int                   @id @default(autoincrement())
  playerId              String
  email                 String?
  customerId            String
  telegramConnections   TelegramConnection[]

  segments              Segment[]             @relation("PlayerSegments")
  fraudAlerts           FraudAlert[]
  riskProfile           PlayerRiskProfile?

  @@unique([playerId, customerId])
  @@index([customerId, playerId])
  @@index([customerId, email])
  @@index([email])
}

model TelegramConnection {
  id             Int    @id @default(autoincrement())
  telegramChatId String
  playerId       Int
  player         Player @relation(fields: [playerId], references: [id])
  customerId     String

  @@unique([playerId])
  @@index([customerId])
  @@index([telegramChatId])
}

model Segment {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  criteria    Json
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  players     Player[] @relation("PlayerSegments")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  @@index([customerId])
  @@index([customerId, createdAt])
  @@index([customerId, updatedAt])
}

model Rule {
  id                    Int             @id @default(autoincrement())
  name                  String
  description           String?
  isActive              Boolean         @default(true)
  triggerType           TriggerType
  config                Json
  
  // Koşullar ve filtreler
  conditions            Json?
  
  // Sıklık kontrolü
  maxExecutionsPerPlayer Int?
  cooldownPeriodDays     Int?
  
  // Zamanlama
  startDate             DateTime?
  endDate               DateTime?
  activeHours           Json?
  activeDaysOfWeek      Json?
  
  // Öncelik
  priority              Int            @default(0)
  
  // A/B Test
  conversionGoalEvent   String?
  testingEnabled        Boolean        @default(false)
  
  // İstatistikler
  totalExecutions       Int            @default(0)
  totalConversions      Int            @default(0)
  lastExecutedAt        DateTime?
  
  customerId            String
  customer              Customer       @relation(fields: [customerId], references: [id])
  variants              RuleVariant[]
  
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @default(now()) @updatedAt

  @@index([customerId, isActive])
  @@index([customerId, isActive, priority])
  @@index([triggerType])
  @@index([priority])
  @@index([lastExecutedAt])
  @@index([startDate])
  @@index([endDate])
  @@index([customerId, triggerType, isActive])
}

model RuleVariant {
  id                    Int            @id @default(autoincrement())
  name                  String
  actionType            ActionType
  actionPayload         Json

  // A/B Test için ağırlık
  weight                Int            @default(1)

  // İstatistikler
  exposures             Int            @default(0)
  conversions           Int            @default(0)

  ruleId                Int
  rule                  Rule           @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @default(now()) @updatedAt

  @@index([ruleId])
  @@index([actionType])
}

model RuleExecution {
  id                    Int            @id @default(autoincrement())
  ruleId                Int
  variantId             Int?
  playerId              String
  executedAt            DateTime       @default(now())
  success               Boolean        @default(true)
  errorMessage          String?

  customerId            String
  customer              Customer       @relation(fields: [customerId], references: [id])

  @@index([customerId, playerId])
  @@index([customerId, ruleId])
  @@index([customerId, playerId, ruleId])
  @@index([ruleId])
  @@index([ruleId, executedAt])
  @@index([executedAt])
  @@index([success])
  @@index([variantId])
  @@index([customerId, executedAt])
  @@index([customerId, success])
}

// ============================================
// FRAUD DETECTION MODELS
// ============================================

model FraudAlert {
  id          String   @id @default(cuid())
  playerId    Int
  player      Player   @relation(fields: [playerId], references: [id])

  alertType   String   // "MULTI_ACCOUNT", "BONUS_ABUSE", "SUSPICIOUS_PATTERN", "RAPID_DEPOSIT_WITHDRAWAL", "HIGH_RISK_IP"
  severity    String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  riskScore   Int      // 0-100

  reason      String   // Detailed explanation
  evidence    Json     // Data points that triggered alert

  status      String   @default("PENDING") // "PENDING", "REVIEWED", "CONFIRMED", "FALSE_POSITIVE"
  reviewedBy  String?
  reviewedAt  DateTime?

  action      String?  // "FLAGGED", "LIMITED", "BLOCKED", "VERIFICATION_REQUIRED"
  actionTaken Boolean  @default(false)

  createdAt   DateTime @default(now())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([playerId])
  @@index([customerId, playerId])
  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
  @@index([customerId, status])
  @@index([customerId, alertType, status])
}

model PlayerRiskProfile {
  id              String   @id @default(cuid())
  playerId        Int      @unique
  player          Player   @relation(fields: [playerId], references: [id])

  riskScore       Int      @default(0) // 0-100
  riskLevel       String   @default("LOW") // "LOW", "MEDIUM", "HIGH", "CRITICAL"

  // Counters
  totalDeposits   Int      @default(0)
  totalWithdrawals Int     @default(0)
  totalBets       Int      @default(0)
  chargebacks     Int      @default(0)

  // Financial metrics
  totalDepositAmount    Float   @default(0)
  totalWithdrawalAmount Float   @default(0)
  totalBetAmount        Float   @default(0)
  netProfit             Float   @default(0) // totalWithdrawal - totalDeposit

  // Flags
  isVpnUser             Boolean  @default(false)
  isProxyUser           Boolean  @default(false)
  hasMultipleAccounts   Boolean  @default(false)
  suspiciousPattern     Boolean  @default(false)
  rapidWithdrawal       Boolean  @default(false)

  // Device tracking
  deviceIds       String[] // Browser fingerprints
  ipAddresses     String[]

  // Behavioral
  avgSessionDuration  Int?    // seconds
  avgTimeBetweenBets  Int?    // seconds

  lastRiskCheck   DateTime @default(now())
  updatedAt       DateTime @updatedAt

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([riskLevel])
  @@index([riskScore])
  @@index([customerId, riskLevel])
  @@index([hasMultipleAccounts])
  @@index([suspiciousPattern])
}
